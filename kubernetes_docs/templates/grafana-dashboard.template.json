{
  "title": "{{APP_NAME}} Application Dashboard",
  "description": "Metrics dashboard for {{APP_NAME}} - auto-synced from repository",
  "tags": ["app", "{{NAMESPACE}}", "{{APP_NAME}}"],
  "timezone": "browser",
  "schemaVersion": 39,
  "refresh": "30s",
  "time": {
    "from": "now-1h",
    "to": "now"
  },
  "templating": {
    "list": [
      {
        "name": "datasource",
        "type": "datasource",
        "query": "prometheus",
        "current": {},
        "hide": 0,
        "includeAll": false,
        "multi": false,
        "options": [],
        "refresh": 1,
        "regex": ""
      },
      {
        "name": "namespace",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${datasource}" },
        "query": "label_values(up{job=~\".*{{APP_NAME}}.*\"}, namespace)",
        "current": { "text": "{{NAMESPACE}}", "value": "{{NAMESPACE}}" },
        "hide": 0,
        "includeAll": false,
        "multi": false,
        "refresh": 2
      },
      {
        "name": "instance",
        "type": "query",
        "datasource": { "type": "prometheus", "uid": "${datasource}" },
        "query": "label_values(up{namespace=\"$namespace\", job=~\".*{{APP_NAME}}.*\"}, instance)",
        "current": {},
        "hide": 0,
        "includeAll": true,
        "multi": true,
        "refresh": 2
      }
    ]
  },
  "panels": [
    {
      "type": "row",
      "title": "Overview",
      "gridPos": { "x": 0, "y": 0, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "type": "stat",
      "title": "App Status",
      "description": "Is the app up and responding?",
      "gridPos": { "x": 0, "y": 1, "w": 4, "h": 4 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "up{namespace=\"$namespace\", job=~\".*{{APP_NAME}}.*\"}",
          "legendFormat": "{{instance}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "mappings": [
            { "type": "value", "options": { "0": { "text": "DOWN", "color": "red" } } },
            { "type": "value", "options": { "1": { "text": "UP", "color": "green" } } }
          ],
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "red" },
              { "value": 1, "color": "green" }
            ]
          }
        }
      },
      "options": {
        "colorMode": "background",
        "graphMode": "none",
        "justifyMode": "center",
        "textMode": "auto"
      }
    },
    {
      "type": "stat",
      "title": "Total Requests",
      "description": "Total HTTP requests served",
      "gridPos": { "x": 4, "y": 1, "w": 4, "h": 4 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "sum(http_requests_total{namespace=\"$namespace\", app=\"{{APP_NAME}}\"})",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "short"
        }
      },
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto"
      }
    },
    {
      "type": "stat",
      "title": "Request Rate",
      "description": "Requests per second (5m avg)",
      "gridPos": { "x": 8, "y": 1, "w": 4, "h": 4 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "sum(rate(http_requests_total{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}[5m]))",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "decimals": 2
        }
      },
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto"
      }
    },
    {
      "type": "stat",
      "title": "Error Rate",
      "description": "5xx errors as percentage of total requests",
      "gridPos": { "x": 12, "y": 1, "w": 4, "h": 4 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "sum(rate(http_requests_total{namespace=\"$namespace\", app=\"{{APP_NAME}}\", status_code=~\"5..\"}[5m])) / sum(rate(http_requests_total{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}[5m])) * 100 or vector(0)",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "percent",
          "decimals": 2,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 1, "color": "yellow" },
              { "value": 5, "color": "red" }
            ]
          }
        }
      },
      "options": {
        "colorMode": "value",
        "graphMode": "area",
        "justifyMode": "auto"
      }
    },
    {
      "type": "stat",
      "title": "Avg Latency (p50)",
      "description": "Median request latency",
      "gridPos": { "x": 16, "y": 1, "w": 4, "h": 4 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "histogram_quantile(0.50, sum(rate(http_request_duration_seconds_bucket{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}[5m])) by (le))",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3
        }
      }
    },
    {
      "type": "stat",
      "title": "P99 Latency",
      "description": "99th percentile request latency",
      "gridPos": { "x": 20, "y": 1, "w": 4, "h": 4 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "histogram_quantile(0.99, sum(rate(http_request_duration_seconds_bucket{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}[5m])) by (le))",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "s",
          "decimals": 3,
          "thresholds": {
            "mode": "absolute",
            "steps": [
              { "value": null, "color": "green" },
              { "value": 0.5, "color": "yellow" },
              { "value": 1, "color": "red" }
            ]
          }
        }
      }
    },
    {
      "type": "row",
      "title": "HTTP Traffic",
      "gridPos": { "x": 0, "y": 5, "w": 24, "h": 1 },
      "collapsed": false
    },
    {
      "type": "timeseries",
      "title": "Request Rate by Status",
      "description": "HTTP requests per second grouped by status code",
      "gridPos": { "x": 0, "y": 6, "w": 12, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "sum(rate(http_requests_total{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}[5m])) by (status_code)",
          "legendFormat": "{{status_code}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 10
          }
        },
        "overrides": [
          {
            "matcher": { "id": "byRegexp", "options": "2.." },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "green" } }]
          },
          {
            "matcher": { "id": "byRegexp", "options": "4.." },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "yellow" } }]
          },
          {
            "matcher": { "id": "byRegexp", "options": "5.." },
            "properties": [{ "id": "color", "value": { "mode": "fixed", "fixedColor": "red" } }]
          }
        ]
      }
    },
    {
      "type": "timeseries",
      "title": "Request Rate by Route",
      "description": "HTTP requests per second grouped by route/endpoint",
      "gridPos": { "x": 12, "y": 6, "w": 12, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "sum(rate(http_requests_total{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}[5m])) by (route)",
          "legendFormat": "{{route}}",
          "refId": "A"
        }
      ],
      "fieldConfig": {
        "defaults": {
          "unit": "reqps",
          "custom": {
            "drawStyle": "line",
            "lineInterpolation": "smooth",
            "fillOpacity": 10
          }
        }
      }
    },
    {
      "type": "heatmap",
      "title": "Request Latency Distribution",
      "description": "Heatmap of request latency distribution over time",
      "gridPos": { "x": 0, "y": 14, "w": 24, "h": 8 },
      "datasource": { "type": "prometheus", "uid": "${datasource}" },
      "targets": [
        {
          "expr": "sum(increase(http_request_duration_seconds_bucket{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}[1m])) by (le)",
          "legendFormat": "{{le}}",
          "refId": "A",
          "format": "heatmap"
        }
      ],
      "options": {
        "calculate": false,
        "cellGap": 1,
        "color": {
          "mode": "scheme",
          "scheme": "Spectral",
          "reverse": true
        },
        "yAxis": {
          "unit": "s"
        }
      }
    },
    {
      "type": "row",
      "title": "Node.js Runtime (if applicable)",
      "gridPos": { "x": 0, "y": 22, "w": 24, "h": 1 },
      "collapsed": true,
      "panels": [
        {
          "type": "timeseries",
          "title": "Memory Usage",
          "gridPos": { "x": 0, "y": 23, "w": 8, "h": 6 },
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "targets": [
            {
              "expr": "process_resident_memory_bytes{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}",
              "legendFormat": "RSS",
              "refId": "A"
            },
            {
              "expr": "nodejs_heap_size_used_bytes{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}",
              "legendFormat": "Heap Used",
              "refId": "B"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "bytes"
            }
          }
        },
        {
          "type": "timeseries",
          "title": "Event Loop Lag",
          "gridPos": { "x": 8, "y": 23, "w": 8, "h": 6 },
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "targets": [
            {
              "expr": "nodejs_eventloop_lag_seconds{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}",
              "legendFormat": "Lag",
              "refId": "A"
            }
          ],
          "fieldConfig": {
            "defaults": {
              "unit": "s"
            }
          }
        },
        {
          "type": "timeseries",
          "title": "Active Handles & Requests",
          "gridPos": { "x": 16, "y": 23, "w": 8, "h": 6 },
          "datasource": { "type": "prometheus", "uid": "${datasource}" },
          "targets": [
            {
              "expr": "nodejs_active_handles_total{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}",
              "legendFormat": "Active Handles",
              "refId": "A"
            },
            {
              "expr": "nodejs_active_requests_total{namespace=\"$namespace\", app=\"{{APP_NAME}}\"}",
              "legendFormat": "Active Requests",
              "refId": "B"
            }
          ]
        }
      ]
    }
  ]
}
